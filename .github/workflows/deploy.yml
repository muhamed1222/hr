name: ğŸš€ Deploy TimeBot to Production

on:
  push:
    branches: [ main, production ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ°
  test:
    name: ğŸ§ª Tests & Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ” Run ESLint
      run: npm run lint || true
      
    - name: ğŸ§ª Run Tests
      run: npm test || true
      
    - name: ğŸ“Š Generate Test Coverage
      run: npm run test:coverage || true
      
    - name: ğŸ“¤ Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        fail_ci_if_error: false

  # ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Admin Panel
  build-frontend:
    name: ğŸ—ï¸ Build Admin Panel
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: admin-panel/package-lock.json
        
    - name: ğŸ“¦ Install Frontend Dependencies
      working-directory: ./admin-panel
      run: npm ci
      
    - name: ğŸ—ï¸ Build Admin Panel
      working-directory: ./admin-panel
      run: npm run build
      env:
        VITE_API_URL: https://your-domain.com/api
        
    - name: ğŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: admin-panel-dist
        path: admin-panel/dist/
        retention-days: 30

  # ğŸ³ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
  build-docker:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
      
    outputs:
      image: ${{ steps.image.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}
      
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ·ï¸ Extract Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: ğŸ”¨ Build and Push Docker Image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ“ Output Image
      id: image
      run: |
        echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}" >> $GITHUB_OUTPUT

  # ğŸš€ Ğ Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° staging
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-frontend, build-docker]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment: 
      name: staging
      url: https://staging.your-domain.com
      
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Frontend Build
      uses: actions/download-artifact@v3
      with:
        name: admin-panel-dist
        path: admin-panel/dist/
        
    - name: ğŸš€ Deploy to Staging Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: ${{ secrets.STAGING_PORT || 22 }}
        script: |
          cd /var/www/timebot-staging
          git pull origin main
          docker-compose down
          docker-compose pull
          docker-compose up -d
          docker system prune -f
          
    - name: ğŸ©º Health Check
      run: |
        sleep 30
        curl -f https://staging.your-domain.com/health || exit 1
        
    - name: ğŸ“¢ Notify Slack (Success)
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'ğŸ‰ TimeBot ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ğ½ÑƒÑ‚ Ğ½Ğ° staging!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ğŸ­ Ğ Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° production
  deploy-production:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-frontend, build-docker, deploy-staging]
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.environment == 'production'
    environment: 
      name: production
      url: https://your-domain.com
      
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Frontend Build
      uses: actions/download-artifact@v3
      with:
        name: admin-panel-dist
        path: admin-panel/dist/
        
    - name: ğŸš€ Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: ${{ secrets.PRODUCTION_PORT || 22 }}
        script: |
          cd /var/www/timebot-production
          git pull origin main
          docker-compose down
          docker-compose pull
          docker-compose up -d
          docker system prune -f
          
    - name: ğŸ©º Health Check
      run: |
        sleep 30
        curl -f https://your-domain.com/health || exit 1
        
    - name: ğŸ“¢ Notify Slack (Success)
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'ğŸš€ TimeBot ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ğ½ÑƒÑ‚ Ğ½Ğ° production!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: ğŸ“¢ Notify Slack (Failure)
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ TimeBot Ğ½Ğ° production!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ğŸ” ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¿Ğ¾ÑĞ»Ğµ Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ
  post-deploy-monitoring:
    name: ğŸ” Post-Deploy Monitoring
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: success()
    
    steps:
    - name: ğŸ©º Extended Health Checks
      run: |
        echo "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ñ… ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ğ¾Ğ²..."
        
        # Health check
        curl -f https://your-domain.com/health
        
        # API endpoints
        curl -f https://your-domain.com/api/auth/verify || true
        
        echo "âœ… Ğ’ÑĞµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹!"
        
    - name: ğŸ“Š Performance Test
      run: |
        echo "ğŸ“Š Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚ĞµÑÑ‚ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸..."
        
        # ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ñ‚ĞµÑÑ‚ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ wrk)
        # wrk -t2 -c10 -d30s https://your-domain.com/health || true
        
        echo "ğŸ“Š Ğ¢ĞµÑÑ‚ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½"
        
    - name: ğŸ¤– Test Telegram Bot
      run: |
        echo "ğŸ¤– Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Telegram Ğ±Ğ¾Ñ‚Ğ°..."
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° webhook (ĞµÑĞ»Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½)
        curl -f "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/getWebhookInfo" || true
        
        echo "ğŸ¤– Telegram Ğ±Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½"
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

  # ğŸ”„ Rollback workflow
  rollback:
    name: ğŸ”„ Rollback
    runs-on: ubuntu-latest
    if: failure() && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    needs: [deploy-production]
    environment: production
    
    steps:
    - name: ğŸ”„ Rollback Production
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          cd /var/www/timebot-production
          git checkout HEAD~1
          docker-compose down
          docker-compose up -d
          
    - name: ğŸ“¢ Notify Rollback
      uses: 8398a7/action-slack@v3
      with:
        status: warning
        text: 'ğŸ”„ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ rollback TimeBot Ğ½Ğ° production!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ğŸ“‹ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°
  generate-report:
    name: ğŸ“‹ Generate Deployment Report
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deploy-monitoring]
    if: always()
    
    steps:
    - name: ğŸ“‹ Create Deployment Report
      run: |
        cat << EOF > deployment-report.md
        # ğŸš€ TimeBot Deployment Report
        
        **Date:** $(date)
        **Commit:** ${{ github.sha }}
        **Branch:** ${{ github.ref }}
        **Triggered by:** ${{ github.actor }}
        
        ## ğŸ“Š Results
        
        - **Tests:** ${{ needs.test.result }}
        - **Frontend Build:** ${{ needs.build-frontend.result }}
        - **Docker Build:** ${{ needs.build-docker.result }}
        - **Staging Deploy:** ${{ needs.deploy-staging.result }}
        - **Production Deploy:** ${{ needs.deploy-production.result }}
        - **Monitoring:** ${{ needs.post-deploy-monitoring.result }}
        
        ## ğŸ”— Links
        
        - **Production:** https://your-domain.com
        - **Staging:** https://staging.your-domain.com
        - **Admin Panel:** https://your-domain.com/admin
        
        ## ğŸ·ï¸ Docker Image
        
        \`\`\`
        ${{ needs.build-docker.outputs.image }}
        \`\`\`
        
        EOF
        
    - name: ğŸ“¤ Upload Report
      uses: actions/upload-artifact@v3
      with:
        name: deployment-report
        path: deployment-report.md 